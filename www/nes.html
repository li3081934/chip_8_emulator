<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        canvas{
            border: 1px solid #999999;
        }
    </style>
</head>
<body>
    <h3 id="index">
        0
    </h3>
    <canvas width="700" height="700" id="can">

    </canvas>
    <button id="jian">----</button>
    <button id="jia">++++</button>
    <input id="offset">

<script>
    function b64EncodeUnicode(str) {
        return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
            return String.fromCharCode('0x' + p1);
        }));
    }
    function pushZero(string){
        //debugger
        if(string.length<8){
            let res='0'+string;
            return pushZero(res)
        }else{
            return string
        }

    }
    function _base64ToArrayBuffer(base64) {
        var binary_string =  window.atob(b64EncodeUnicode(base64));
        var len = binary_string.length;
        var bytes = new Uint8Array( len );
        for (var i = 0; i < len; i++)        {
            bytes[i] = binary_string.charCodeAt(i);
        }
        return bytes
    }
    function ajax(url,callback) {
        let xhr=new XMLHttpRequest();
        xhr.open("GET", url, true);
        xhr.responseType='arraybuffer';
        xhr.onreadystatechange = function(){
            if(xhr.readyState === 4){
                // 判断服务器端返回响应信息所带的状态码
                if(xhr.status === 200){
                    if(callback){
                        callback(xhr.response);

                    }
                }
            }
        };
        xhr.send(null);
    }

    ajax('/mar.nes',(res)=>{

        let data =new Uint8Array(res);
        //let data=_base64ToArrayBuffer(res);
        console.log(data.byteLength)
        let blockSize=16,unitSize=10,picW=8;

        const can=document.querySelector('#can')
        const ctx=can.getContext('2d')
        const colors=['rgba(0,0,0,0)','rgba(253,160,0,1)','rgba(225,80,1,1)','rgba(137,136,1,1)']   //chao ji ma li
        //const colors=['rgba(0,0,0,0)','rgba(164,2,0,1)','rgba(241,106,103,1)','rgba(255,255,255,1)']

        let index=0,pageSize=16
        let page=0,offset=0
        drawPage(page)
        function drawPage() {
            index=64*16*page+parseInt(offset)*16;
            document.querySelector('#index').innerHTML=index
            ctx.clearRect(0,0,700,700)
            for(let i=0;i<8;i++){
                for(let k=0;k<8;k++){
                    let blockData=data.slice((k+i*8)*16+index);
                    drawBlock(ctx,unitSize,k*picW*unitSize,i*picW*unitSize,blockData,picW,colors)
                }


            }
        }
        function drawBlock(ctx,unitSize,sX,sY,blockData,picW,colors) {
            //console.log(blockData)
            debugger
            for(let i=0;i<8;i++){
                let h=pushZero(blockData[i].toString(2)),l=pushZero(blockData[i+8].toString(2));
                for(let k=0;k<8;k++){
                    let dot=h.charAt(k)+l.charAt(k);
                    ctx.fillStyle= colors[parseInt(dot,2)];
                    //debugger
                    //d++
                    ctx.fillRect(sX+k*unitSize,sY+i*unitSize,unitSize,unitSize)
                    //ctx.fillRect(i/2*unitSize,k*unitSize,unitSize,unitSize)
                    //drawDot(ctx,unitSize,k*unitSize,i+unitSize)
                }

            }
        }

        document.querySelector('#jia').onclick=()=>{
            page++
            drawPage()
        }
        document.querySelector('#jian').onclick=()=>{
            page--
            drawPage()
        }
        document.querySelector('#offset').onchange=function(){
            debugger
            offset=this.value
            drawPage()
        }



    })
</script>
</body>
</html>