<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="js/interpreter.js"></script>
    <style>
        canvas{
            border: 1px solid #999999;
        }
    </style>
</head>
<body>
    <canvas id="can" width="640" height="320">

    </canvas>
<script>
    const can=document.querySelector('#can');
    const ctx=can.getContext('2d')
    const Zoom=5
    function ajax(url,callback) {
        let xhr=new XMLHttpRequest();
        xhr.open("GET", url, true);
        xhr.responseType='arraybuffer';
        xhr.onreadystatechange = function(){
            if(xhr.readyState === 4){
                // 判断服务器端返回响应信息所带的状态码
                if(xhr.status === 200){
                    if(callback){
                        callback(xhr.response);

                    }
                }
            }
        };
        xhr.send(null);
    }
    ajax('PONG',(res)=>{
        let dataBuffer=new Uint8Array(res),stack=[],
            memory=new Uint8Array(4096);

        //console.log(dataBuffer)
        for(let i=0;i<dataBuffer.length;i++){

            memory[512+i]=dataBuffer[i]
        }
        //console.log(memory)
        let pc=0 ,start=0,delay_timer=60,sound_timer=60 ;


        let V=new Uint8Array(16),I=0
        while (pc<dataBuffer.length){

            let code=dataBuffer[pc+start] << 8 | dataBuffer[pc + 1+start]
           // console.log(code)
            //console.log(code& 0xF000)
            //console.log(code.toString(16))

            switch(code & 0xF000){
//                case 0x2000:
//                    debugger
//                    stack.push(pc)
//                    pc = code & 0x0FFF;//跳转
//                    break
                case 0x6000: //6XNN:把NN赋给Cpu寄存器的x索引上
                    //console.log(code.toString(16))
//                    let vIndex= (code&0x0F00)>>8
//                    let value=code&0x00FF
//                    V[vIndex]=value
                    In_0x6000(code,V);
                    break
                case 0x7000: //7XNN:把NN与Cpu寄存器的x索引上的值加等
                    //console.log(code.toString(16))
                    In_0x7000(code,V);
                    break
                case 0x8000:
                    In_0x8000(code,V);
                    break
                case 0xA000:

                    I=code&0x0FFF
                    break
                case 0xB000:

                    pc=V[0]+(code&0x0FFF)
                    debugger
                    break
                case 0xD000:
                    let drawX=V[(code&0x0f00)>>8]
                    let drawY=V[(code&0x00f0)>>4]
                    const width=8;
                    let height=code&0x000f
                    //console.log(height)
                    ctx.fillRect(drawX*Zoom,drawY*Zoom,width*Zoom,height*Zoom)
                    //debugger
                    break
                case 0xF000:

                    switch (code&0x00ff){
                        case 0x15:
                            delay_timer=V[(code&0x0f00)>>8]
                            //console.log(code.toString(16))
                            break
                        case 0x7:
                            V[(code&0x0f00)>>8]=delay_timer
                            //console.log(code.toString(16))
                            break
                        case 0x18:
                            sound_timer=V[(code&0x0f00)>>8]
                            //console.log(code.toString(16))
                            break
                        case 0x33:
                            let num=V[(code&0x0f00)>>8]

                            //todo: 目前有问题vx是个两位数 可能对v的赋值之类不完整
                            memory[I]=num/100
                            memory[I+1]=num/10
                            memory[I+2]=num%100

                            console.log(num)
                            console.log(V)
                            console.log(I)
                            console.log(memory)

                            break
                        case 0x65:
                            let x=V[(code&0x0f00)>>8]
                            for(let i=0;i<=V[x];i++){
                                V[i]=memory[I + i]

                            }
                            I=I+x+1
                            //console.log(code.toString(16))
                            break
                        case 0x29:
                            //todo:字符集暂无
                           // console.log(code.toString(16))
                            break
                        default:
                            console.log ("Unknown opcode:\n"+ code.toString(16)+' \n'+pc);
                    }
                    break

                default:
                    console.log ("Unknown opcode:\n"+ code.toString(16)+' \n'+pc);

            }

            pc+=2;

        }
        delay_timer--;
        sound_timer--
        //V.forEach((x)=>console.log(x))

    })
</script>


</body>
</html>